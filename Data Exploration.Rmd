---
title: "Data Exploration"
author: "Dominik Meier"
date: "12 9 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12/1.3, fig.height = 8/1.3)
```

```{r}
library(tidyverse)
library(lubridate)
library(text2sdg)
library(cowplot)
library(corrplot)
```

```{r}
df <- read_csv("all_projects_translated.csv")
```

```{r}
names(df)
```

## Frequency of Funding Instruments
```{r}
df %>% 
  mutate(`Funding Instrument` = fct_lump_min(`Funding Instrument`, 150)) %>% 
  count(`Funding Instrument`) %>% 
  ggplot(aes(y = fct_reorder(`Funding Instrument`, n), x = n)) +
  geom_col() + 
  labs(title = "Frequency of Funding Instruments",
       y = "")
```

## Frequency of Universities
```{r}
df %>% 
  filter(!is.na(University)) %>% 
  mutate(University = fct_lump_min(University, 100)) %>% 
  count(University) %>% 
  ggplot(aes(y = fct_reorder(University, n), x = n)) +
  geom_col() + 
  labs(title = "Frequency of Universities",
       y = "")
```


## Frequency of Project Discipline Names
```{r}
df %>% 
  filter(!is.na(`Discipline Name`)) %>% 
  mutate(`Discipline Name` = fct_lump_min(`Discipline Name`, 700)) %>% 
  count(`Discipline Name`) %>% 
  ggplot(aes(y = fct_reorder(`Discipline Name`, n), x = n)) +
  geom_col() + 
  labs(title = "Frequency of Project Discipline Names",
       y = "")
```

## Approved Amount
```{r}
df %>% 
  filter(`Approved Amount` != "data not included in P3") %>% 
  mutate(`Approved Amount` = log(as.numeric(`Approved Amount`))) %>% 
  ggplot(aes(x = `Approved Amount`)) +
  geom_histogram(binwidth = .2) +
  labs(title = "Histogram of log of approved amount in CHF")

df %>% 
  filter(`Approved Amount` != "data not included in P3") %>% 
  mutate(`Approved Amount` = as.numeric(`Approved Amount`)) %>% 
  filter(`Approved Amount` < 1000000) %>% 
  ggplot(aes(x = `Approved Amount`)) +
  geom_histogram(binwidth = 1000) +
  labs(title = "Histogram of approved amount in CHF of projects with approved amount < 1 Mio. CHF")

df %>% 
  filter(`Approved Amount` != "data not included in P3") %>% 
  mutate(`Approved Amount` = as.numeric(`Approved Amount`)) %>% 
  filter(`Approved Amount` >= 1000000) %>% 
  ggplot(aes(x = `Approved Amount`)) +
  geom_histogram(binwidth = 10000) +
  labs(title = "Histogram of approved amount in CHF of projects with approved amount >= 1 Mio. CHF")
```


## Start Date
```{r}
df <- df %>% 
  mutate(`Start Date` = dmy(`Start Date`),
         `End Date` = dmy(`End Date`),
         project_length = `End Date` - `Start Date`)


df %>% 
  mutate(start_year = year(`Start Date`)) %>% 
  ggplot(aes(x = start_year)) +
  geom_bar() +
  labs(title = "Funded Projects per Year", 
       x = "Year")

df %>% 
  mutate(abstract_missing = is.na(Abstract)) %>% 
  mutate(start_year = year(`Start Date`)) %>% 
  ggplot(aes(x = start_year, fill = abstract_missing)) +
  geom_bar() +
  labs(title = "Number of funded projects per year", 
       x = "Year")
```




## Project Length
```{r}
df %>% 
  mutate(project_length = project_length / 365) %>% 
  ggplot(aes(x = project_length)) +
  geom_histogram(binwidth = .1) +
  scale_x_continuous(breaks = seq(0, by = 1, length.out = 7)) +
  labs(title = "Histogram of Project Duration in years",
       x = "")
```

## Correlation between Project Length (days) and Approved Amount (CHF)
```{r}
df %>% 
  filter(`Approved Amount` != "data not included in P3") %>% 
  mutate(`Approved Amount` = as.numeric(`Approved Amount`)) %>% 
  ggplot(aes(x = project_length, y = `Approved Amount`)) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm")


df %>% 
  filter(`Approved Amount` != "data not included in P3") %>% 
  mutate(`Approved Amount` = as.numeric(`Approved Amount`),
         project_length = as.numeric(project_length)) %>% 
  cor.test(.$`Approved Amount`, .$project_length, df = .)
```


# Join hits on df
```{r}
hits <- read_csv("sdg_hits_features.csv")

hits[["document"]] <- as.factor(hits[["document"]])

df_sdgs <- df %>% 
  mutate(document = as.factor(1:n())) %>% 
  full_join(hits) 

```


## Plot sdgs
```{r}
plot_sdg(df_sdgs, systems = c("aurora", "elsevier", "siris", "ontology", "sdsn"))
```

## Correlation between systems
```{r}
cor_systems <- crosstab_sdg(df_sdgs, systems = c("aurora", "elsevier", "siris", "ontology", "sdsn"))


col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

corrplot(cor_systems, method="color", col=col(200),  
     diag=FALSE, # tl.pos="d", 
         type="upper", 
         addCoef.col = "black", # Add coefficient of correlation
         # hide correlation coefficient on the principal diagonal
     mar=c(0,0,1,0) # http://stackoverflow.com/a/14754408/54964
         )
```



## Correlation between SDGs per System
```{r}

systems = c("aurora", "elsevier", "siris", "ontology", "sdsn")


for (system in systems) {
  
  print(paste0("Correlation for system ", system))

  
    corrplot(crosstab_sdg(hits, compare = "sdgs", systems = system), method="color", col=col(200),  
     diag=FALSE, # tl.pos="d", 
         type="upper", 
     title=paste0("Correlation for system ", system), 
         addCoef.col = "black", # Add coefficient of correlation
         # hide correlation coefficient on the principal diagonal
     mar=c(0,0,1,0) # http://stackoverflow.com/a/14754408/54964
         )
  
  
}


```




## Hits per document and system
```{r}
a <- df_sdgs %>% 
  distinct(document, sdg, system) %>% 
  filter(!is.na(document)) %>% 
  mutate(hit = if_else(is.na(system), 0, 1)) %>% 
  group_by(document) %>% 
  summarise(n_hits = sum(hit)) %>% 
  ggplot(aes(x = n_hits)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Histogram of number of hits per document")

b <- df_sdgs %>% 
  distinct(document, sdg, system) %>% 
  filter(!is.na(document)) %>% 
  mutate(hit = if_else(is.na(system), 0, 1)) %>% 
  group_by(document) %>% 
  summarise(n_hits = sum(hit)) %>%
  filter(n_hits > 0) %>% 
  ggplot(aes(x = n_hits)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Histogram of number of hits per document",
       subtitle = "Only documents with at least one hit")

plot_grid(a, b)
```



## Hits per document and system
```{r}
df_sdgs %>% 
  distinct(document, sdg, system) %>% 
  filter(!is.na(document)) %>% 
  mutate(hit = if_else(is.na(system), 0, 1)) %>% 
  filter(!is.na(system)) %>% 
  group_by(document, system) %>% 
  summarise(n_hits = sum(hit)) %>% 
  ggplot(aes(x = n_hits)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~system)+
  labs(title = "Histogram of number of hits per document and system")

```




## sdgs time trend
```{r}
df_sdgs %>% 
  distinct(document, sdg, system, `Start Date`) %>% 
  filter(!is.na(sdg)) %>% 
  count(sdg, year = year(`Start Date`)) %>% 
  ggplot(aes(x = year, y = n)) +
  geom_col() +
  facet_wrap(~sdg)

df_sdgs %>% 
  distinct(document, sdg, system, `Start Date`) %>% 
  filter(!is.na(sdg)) %>% 
  count(sdg, year = year(`Start Date`)) %>% 
  ggplot(aes(x = year, y = n, fill = sdg)) +
  geom_area() 


df_sdgs %>% 
  distinct(document, sdg, system, `Start Date`) %>% 
  filter(!is.na(sdg)) %>% 
  count(sdg, year = year(`Start Date`)) %>% 
  group_by(year) %>% 
  mutate(sum_year = sum(n),
         prop = n / sum_year) %>% 
  ggplot(aes(x = year, y = prop, fill = sdg)) +
  geom_col() 
```


## SDGs per discipline (Top 10 Disciplines)
### With multiple hits per sdg (one for each system)
```{r}
df_sdgs %>% 
  distinct(document, sdg, system, `Discipline Name`) %>% 
  filter(!is.na(`Discipline Name`)) %>% 
  mutate(`Discipline Name` = fct_lump_n(`Discipline Name`, n = 11)) %>% 
  ggplot(aes(y = sdg)) +
  geom_bar() +
  facet_wrap(~`Discipline Name`, scales = "free")
```

### Without multiple hits per sdg 
```{r}
df_sdgs %>% 
  distinct(document, sdg, `Discipline Name`) %>% 
  filter(!is.na(`Discipline Name`)) %>% 
  mutate(`Discipline Name` = fct_lump_n(`Discipline Name`, n = 11)) %>% 
  ggplot(aes(y = sdg)) +
  geom_bar() +
  facet_wrap(~`Discipline Name`, scales = "free")
```


## SDGs and approved amount
```{r}
df_sdgs %>% 
  filter(`Approved Amount` != "data not included in P3") %>% 
  mutate(`Approved Amount` = as.numeric(`Approved Amount`)) %>% 
  distinct(document, sdg, `Approved Amount`) %>% 
  filter(!is.infinite(`Approved Amount`)) %>% 
  group_by(sdg) %>% 
  summarise(mean_approved_amount = mean(`Approved Amount`, na.rm = TRUE)) %>% 
  ggplot(aes(y = sdg, x = mean_approved_amount)) +
  geom_col() +
  labs(title = "Mean approved amount by SDG")
```






